<!doctype html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=5.0"
    />
    <meta name="description" content="–ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ ‚Äî Core City" />
    <title>–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä ‚Äî Core City</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <!-- Chart.js –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–æ–≤ -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <!-- Leaflet –¥–ª—è –∫–∞—Ä—Ç—ã -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"
    />
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"
    />
    <!-- –ù–∞—à–∏ —Å—Ç–∏–ª–∏ -->
    <link rel="stylesheet" href="css/main.css" />
    <link rel="stylesheet" href="css/admin.css" />
  </head>
  <body>
    <!-- Navbar -->
    <nav class="navbar">
      <div class="container">
        <div class="navbar-inner">
          <div class="logo">üèôÔ∏è Core City</div>
          <div class="nav-links">
            <span id="nav-username"></span>
            <span class="admin-badge">–ì–ª–∞–≤–Ω—ã–π –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</span>
            <button onclick="logout()" class="btn-logout">–í—ã–π—Ç–∏</button>
          </div>
        </div>
      </div>
    </nav>

    <!-- Floating Assign Worker Button -->
    <button id="floating-assign-btn" class="floating-assign-btn" title="–ù–∞–∑–Ω–∞—á–∏—Ç—å –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è">
      üë∑‚Äç‚ôÇÔ∏è –ù–∞–∑–Ω–∞—á–∏—Ç—å
    </button>

    <div class="admin-layout">
      <!-- –°–∞–π–¥–±–∞—Ä –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ -->
      <aside class="admin-sidebar" id="adminSidebar">
        <div class="sidebar-toggle" id="sidebarToggle">
          <span class="toggle-icon">¬´</span>
        </div>
        <div class="admin-profile">
          <div class="admin-avatar">üë©‚Äçüíº</div>
          <div class="admin-info">
            <h4>–ï–ª–µ–Ω–∞ –ê–¥–º–∏–Ω–æ–≤–∞</h4>
            <span class="admin-role">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</span>
          </div>
        </div>

        <nav class="admin-nav">
          <a href="#" class="nav-item active" data-section="dashboard">
            <span class="nav-icon">üìä</span>
            <span>–î–∞—à–±–æ—Ä–¥</span>
          </a>
          <a href="#" class="nav-item" data-section="requests">
            <span class="nav-icon">üìã</span>
            <span>–ó–∞—è–≤–∫–∏</span>
            <span class="nav-badge">24</span>
          </a>
          <a href="#" class="nav-item" data-section="map">
            <span class="nav-icon">üó∫Ô∏è</span>
            <span>–ö–∞—Ä—Ç–∞</span>
          </a>
          <a href="#" class="nav-item" data-section="workers">
            <span class="nav-icon">üë•</span>
            <span>–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–∏</span>
          </a>
          <a href="#" class="nav-item" data-section="analytics">
            <span class="nav-icon">üìà</span>
            <span>–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</span>
          </a>
        </nav>

        <div class="system-status">
          <h4>–°—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã</h4>
          <div class="status-item">
            <span class="status-label">–°–µ—Ä–≤–µ—Ä</span>
            <span class="status-value online">‚óè Online</span>
          </div>
          <div class="status-item">
            <span class="status-label">–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö</span>
            <span class="status-value online">‚óè Connected</span>
          </div>
          <div class="status-item">
            <span class="status-label">SLA</span>
            <span class="status-value">98.7%</span>
          </div>
        </div>
      </aside>

      <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
      <main class="admin-main">
        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∏ —Ñ–∏–ª—å—Ç—Ä—ã -->
        <div class="content-header">
          <h1 class="page-title">–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</h1>
          <div class="date-range">
            <select class="input" style="width: 200px">
              <option>–ü–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π</option>
              <option>–ü–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π</option>
              <option>–≠—Ç–æ—Ç –º–µ—Å—è—Ü</option>
            </select>
            <button class="btn btn-outline btn-small" onclick="exportData()">üì• –≠–∫—Å–ø–æ—Ä—Ç</button>
          </div>
        </div>

        <!-- –°–µ–∫—Ü–∏—è –¥–∞—à–±–æ—Ä–¥–∞ -->
        <section id="dashboard-section">
          <!-- KPI –ö–∞—Ä—Ç–æ—á–∫–∏ -->
          <div class="kpi-grid">
            <div class="kpi-card">
              <div class="kpi-icon blue">üìã</div>
              <div class="kpi-content">
                <span class="kpi-label">–í—Å–µ–≥–æ –∑–∞—è–≤–æ–∫</span>
                <span class="kpi-value" id="stat-total">1,247</span>
                <span class="kpi-trend positive">‚Üë 12%</span>
              </div>
            </div>
            <div class="kpi-card">
              <div class="kpi-icon yellow">‚è≥</div>
              <div class="kpi-content">
                <span class="kpi-label">–í —Ä–∞–±–æ—Ç–µ</span>
                <span class="kpi-value" id="stat-in-progress">156</span>
                <span class="kpi-trend">‚Üò 3%</span>
              </div>
            </div>
            <div class="kpi-card">
              <div class="kpi-icon green">‚úÖ</div>
              <div class="kpi-content">
                <span class="kpi-label">–í—ã–ø–æ–ª–Ω–µ–Ω–æ —Å–µ–≥–æ–¥–Ω—è</span>
                <span class="kpi-value" id="stat-completed-today">89</span>
                <span class="kpi-trend positive">‚Üë 8%</span>
              </div>
            </div>
            <div class="kpi-card">
              <div class="kpi-icon red">‚ö†Ô∏è</div>
              <div class="kpi-content">
                <span class="kpi-label">–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ</span>
                <span class="kpi-value" id="stat-overdue">12</span>
                <span class="kpi-trend negative">‚Üë 2</span>
              </div>
            </div>
          </div>

          <!-- –ì—Ä–∞—Ñ–∏–∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–π -->
          <div class="charts-row">
            <div class="chart-card" style="grid-column: 1 / -1;">
              <h3>üìä –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –∑–∞—è–≤–æ–∫</h3>
              <img 
                id="chart-categories-img"
                src="https://quickchart.io/chart?width=600&height=400&chart=%7B%22type%22%3A%22bar%22%2C%22data%22%3A%7B%22labels%22%3A%5B%22%D0%9E%D1%81%D0%B2%D0%B5%D1%89%D0%B5%D0%BD%D0%B8%D0%B5%22%2C%22%D0%94%D0%BE%D1%80%D0%BE%D0%B3%D0%B8%22%2C%22%D0%9C%D1%83%D1%81%D0%BE%D1%80%22%2C%22%D0%94%D1%80%D1%83%D0%B3%D0%BE%D0%B5%22%5D%2C%22datasets%22%3A%5B%7B%22label%22%3A%22%D0%9A%D0%BE%D0%BB%D0%B8%D1%87%D0%B5%D1%81%D1%82%D0%B2%D0%BE%20%D0%B7%D0%B0%D1%8F%D0%B2%D0%BE%D0%BA%22%2C%22data%22%3A%5B234%2C678%2C456%2C155%5D%2C%22backgroundColor%22%3A%5B%22%233e95cd%22%2C%22%238e5ea2%22%2C%22%233cba9f%22%2C%22%23e8c3b9%22%5D%7D%5D%7D%2C%22options%22%3A%7B%22plugins%22%3A%7B%22title%22%3A%7B%22display%22%3Atrue%2C%22text%22%3A%22%D0%97%D0%B0%D1%8F%D0%B2%D0%BA%D0%B8%20%D0%BF%D0%BE%20%D0%BA%D0%B0%D1%82%D0%B5%D0%B3%D0%BE%D1%80%D0%B8%D1%8F%D0%BC%22%7D%2C%22legend%22%3A%7B%22display%22%3Atrue%7D%7D%2C%22scales%22%3A%7B%22y%22%3A%7B%22beginAtZero%22%3Atrue%2C%22max%22%3A800%2C%22ticks%22%3A%7B%22stepSize%22%3A200%7D%7D%7D%7D%7D"
                alt="–ì—Ä–∞—Ñ–∏–∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–π –∑–∞—è–≤–æ–∫"
                style="width: 100%; height: 300px;"
              >
            </div>
          </div>
        </section>

        <!-- –°–µ–∫—Ü–∏—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ -->
        <section id="analytics-section" style="display: none">
          <div class="table-card">
            <h3>üìà –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –∏ –æ—Ç—á–µ—Ç—ã</h3>
            <div class="analytics-content">
              <div class="kpi-grid">
                <div class="kpi-card">
                  <div class="kpi-icon blue">üìä</div>
                  <div class="kpi-content">
                    <span class="kpi-label">–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ –∑–∞—è–≤–æ–∫</span>
                    <span class="kpi-value">1,247</span>
                    <span class="kpi-trend positive">‚Üë 12%</span>
                  </div>
                </div>
                <div class="kpi-card">
                  <div class="kpi-icon green">‚úÖ</div>
                  <div class="kpi-content">
                    <span class="kpi-label">–í—ã–ø–æ–ª–Ω–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ</span>
                    <span class="kpi-value">1,189</span>
                    <span class="kpi-trend positive">‚Üë 8%</span>
                  </div>
                </div>
                <div class="kpi-card">
                  <div class="kpi-icon yellow">‚è±Ô∏è</div>
                  <div class="kpi-content">
                    <span class="kpi-label">–°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è</span>
                    <span class="kpi-value">18.5 —á</span>
                    <span class="kpi-trend">‚Üò 1.2—á</span>
                  </div>
                </div>
                <div class="kpi-card">
                  <div class="kpi-icon red">üéØ</div>
                  <div class="kpi-content">
                    <span class="kpi-label">–£–¥–æ–≤–ª–µ—Ç–≤–æ—Ä–µ–Ω–Ω–æ—Å—Ç—å</span>
                    <span class="kpi-value">94%</span>
                    <span class="kpi-trend positive">‚Üë 5%</span>
                  </div>
                </div>
              </div>

              <!-- –ì—Ä–∞—Ñ–∏–∫ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ -->
              <div class="chart-card">
                <h3>üìä –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º</h3>
                <img id="analytics-performance-img" src="https://quickchart.io/chart?width=600&height=400&chart=%7B%22type%22%3A%22bar%22%2C%22data%22%3A%7B%22labels%22%3A%5B%22%D0%9E%D1%81%D0%B2%D0%B5%D1%89%D0%B5%D0%BD%D0%B8%D0%B5%22%2C%22%D0%94%D0%BE%D1%80%D0%BE%D0%B3%D0%B8%22%2C%22%D0%9C%D1%83%D1%81%D0%BE%D1%80%22%2C%22%D0%97%D0%B5%D0%BB%D0%B5%D0%BD%D1%8B%D0%B5%20%D0%BD%D0%B0%D1%81%D0%B0%D0%B6%D0%B4%D0%B5%D0%BD%D0%B8%D1%8F%22%2C%22%D0%94%D1%80%D1%83%D0%B3%D0%BE%D0%B5%22%5D%2C%22datasets%22%3A%5B%7B%22label%22%3A%22%D0%92%D1%8B%D0%BF%D0%BE%D0%BB%D0%BD%D0%B5%D0%BD%D0%BE%20%D0%B7%D0%B0%D1%8F%D0%B2%D0%BE%D0%BA%22%2C%22data%22%3A%5B234%2C456%2C321%2C156%2C80%5D%2C%22backgroundColor%22%3A%5B%22rgba(59%2C130%2C246%2C0.7)%22%2C%22rgba(245%2C158%2C11%2C0.7)%22%2C%22rgba(16%2C185%2C129%2C0.7)%22%2C%22rgba(16%2C185%2C129%2C0.7)%22%2C%22rgba(139%2C92%2C246%2C0.7)%22%5D%7D%2C%7B%22label%22%3A%22%D0%A1%D1%80%D0%B5%D0%B4%D0%BD%D0%B5%D0%B5%20%D0%B2%D1%80%D0%B5%D0%BC%D1%8F%20%D0%B2%D1%8B%D0%BF%D0%BE%D0%BB%D0%BD%D0%B5%D0%BD%D0%B8%D1%8F%20(%D1%87%D0%B0%D1%81%D1%8B)%22%2C%22data%22%3A%5B12.5%2C22.3%2C18.7%2C15.2%2C25.1%5D%2C%22type%22%3A%22line%22%2C%22borderColor%22%3A%22rgb(239%2C68%2C68)%22%2C%22backgroundColor%22%3A%22rgba(239%2C68%2C68%2C0.5)%22%2C%22fill%22%3Afalse%7D%5D%7D%2C%22options%22%3A%7B%22plugins%22%3A%7B%22title%22%3A%7B%22display%22%3Atrue%2C%22text%22%3A%22%D0%AD%D1%84%D1%84%D0%B5%D0%BA%D1%82%D0%B8%D0%B2%D0%BD%D0%BE%D1%81%D1%82%D1%8C%20%D0%BF%D0%BE%20%D0%BA%D0%B0%D1%82%D0%B5%D0%B3%D0%BE%D1%80%D0%B8%D1%8F%D0%BC%20%D0%B7%D0%B0%D1%8F%D0%B2%D0%BE%D0%BA%22%7D%2C%22legend%22%3A%7B%22position%22%3A%22top%22%7D%7D%2C%22scales%22%3A%7B%22y%22%3A%7B%22beginAtZero%22%3Atrue%2C%22title%22%3A%7B%22display%22%3Atrue%2C%22text%22%3A%22%D0%9A%D0%BE%D0%BB%D0%B8%D1%87%D0%B5%D1%81%D1%82%D0%B2%D0%BE%22%7D%7D%7D%7D%7D" alt="–ì—Ä–∞—Ñ–∏–∫ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏" style="width: 100%; height: 300px;">
              </div>
            </div>
          </div>
        </section>

        <!-- –°–µ–∫—Ü–∏—è –∫–∞—Ä—Ç—ã –≥–æ—Ä—è—á–∏—Ö —Ç–æ—á–µ–∫ -->
        <section id="map-section" style="display: none">
          <div class="map-card">
            <div class="map-header">
              <h3>üó∫Ô∏è –ö–∞—Ä—Ç–∞ –æ–±—Ä–∞—â–µ–Ω–∏–π</h3>
              <div class="map-filters">
                <select class="input" style="width: 150px">
                  <option>–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>
                </select>
                <select class="input" style="width: 150px">
                  <option>–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
                </select>
              </div>
            </div>
            <div
              id="hotspot-map"
              style="height: 500px; width: 100%; border-radius: 16px"
            ></div>
          </div>
        </section>

        <!-- –°–µ–∫—Ü–∏—è –∑–∞—è–≤–æ–∫ -->
        <section id="requests-section" style="display: none">
          <div class="table-card">
            <div class="table-header">
              <h3>üìã –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞—è–≤–∫–∞–º–∏</h3>
              <div class="table-filters">
                <select
                  id="requestStatusFilter"
                  class="input"
                  style="width: 150px"
                >
                  <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
                  <option value="pending">–û–∂–∏–¥–∞–µ—Ç</option>
                  <option value="assigned">–ù–∞–∑–Ω–∞—á–µ–Ω–æ</option>
                  <option value="in_progress">–í —Ä–∞–±–æ—Ç–µ</option>
                  <option value="completed">–í—ã–ø–æ–ª–Ω–µ–Ω–æ</option>
                </select>
                <select
                  id="requestCategoryFilter"
                  class="input"
                  style="width: 150px"
                >
                  <option value="">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>
                  <option value="lighting">–û—Å–≤–µ—â–µ–Ω–∏–µ</option>
                  <option value="garbage">–ú—É—Å–æ—Ä</option>
                  <option value="pothole">–î–æ—Ä–æ–≥–∏</option>
                </select>
                <button
                  class="btn btn-primary btn-small"
                  onclick="openAssignModal()"
                >
                  ‚ûï –ù–∞–∑–Ω–∞—á–∏—Ç—å
                </button>
              </div>
            </div>

            <div class="table-responsive">
              <table class="data-table" id="requests-table">
                <thead>
                  <tr>
                    <th onclick="sortTable('id')">ID</th>
                    <th onclick="sortTable('category')">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th>
                    <th onclick="sortTable('address')">–ê–¥—Ä–µ—Å</th>
                    <th onclick="sortTable('status')">–°—Ç–∞—Ç—É—Å</th>
                    <th onclick="sortTable('priority')">–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</th>
                    <th onclick="sortTable('citizen')">–ñ–∏—Ç–µ–ª—å</th>
                    <th onclick="sortTable('worker')">–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å</th>
                    <th onclick="sortTable('created_at')">–°–æ–∑–¥–∞–Ω–∞</th>
                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                  </tr>
                </thead>
                <tbody id="requests-table-body">
                  <!-- –ó–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ JS -->
                </tbody>
              </table>
            </div>

            <div class="table-footer">
              <div class="pagination">
                <span class="pagination-info">–ü–æ–∫–∞–∑–∞–Ω–æ 1-10 –∏–∑ 1,247</span>
              </div>
            </div>
          </div>
        </section>

        <!-- –°–µ–∫—Ü–∏—è –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–µ–π -->
        <section id="workers-section" style="display: none">
          <div class="table-card">
            <h3>üë• –†–µ–π—Ç–∏–Ω–≥ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–µ–π</h3>
            <div class="table-responsive">
              <table class="data-table" id="workers-table">
                <thead>
                  <tr>
                    <th onclick="sortWorkers('name')">–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å</th>
                    <th onclick="sortWorkers('assigned')">–ù–∞–∑–Ω–∞—á–µ–Ω–æ</th>
                    <th onclick="sortWorkers('completed')">–í—ã–ø–æ–ª–Ω–µ–Ω–æ</th>
                    <th onclick="sortWorkers('rate')">%</th>
                    <th onclick="sortWorkers('avg_time')">–°—Ä. –≤—Ä–µ–º—è</th>
                    <th onclick="sortWorkers('rating')">–†–µ–π—Ç–∏–Ω–≥</th>
                  </tr>
                </thead>
                <tbody id="workers-table-body">
                  <!-- –ó–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ JS -->
                </tbody>
              </table>
            </div>
          </div>
        </section>
      </main>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è -->
    <div id="assignModal" class="modal-overlay" style="display: none">
      <div class="modal" style="max-width: 500px">
        <button class="modal-close" onclick="closeAssignModal()">√ó</button>
        <h3 style="margin-bottom: 24px">–ù–∞–∑–Ω–∞—á–∏—Ç—å –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è</h3>
        <div id="assignModalContent">
          <!-- –ó–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ JS -->
        </div>
      </div>
    </div>

    <!-- –°–∫—Ä–∏–ø—Ç—ã -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/admin.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        if (!requireAuth()) return;

        const user = getCurrentUser();
        if (user) {
          document.getElementById("nav-username").textContent =
            user.full_name || user.email;
        }

        initAdminPage();
      });
    </script>
  </body>
</html>
